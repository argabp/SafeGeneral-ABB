@model ABB.Web.Modules.EntriPenyelesaianPiutang.Models.EntriPenyelesaianPiutangViewModel
@using ABB.Application.EntriPenyelesaianPiutangs.Queries
@using Kendo.Mvc.UI
@{
    bool isEditMode = Model.PenyelesaianHeader != null;
}

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Kendo.Mvc

<div class="window-body">
   <form id="PenyelesaianPiutangForm">
        <fieldset>
            <legend>Detail Penyelesaian</legend>
            <div class="row">
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.KodeCabang"></label>
                    <kendo-combobox for="PenyelesaianHeader.KodeCabang"
                                    style="width: 100%;"
                                    datatextfield="Text"
                                    datavaluefield="Value"
                                    bind-to="ViewBag.KodeCabangOptions"
                                    filter="FilterType.Contains"
                                    placeholder="Pilih Cabang..."
                                   >
                    </kendo-combobox>
                </div>
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.JenisPenyelesaian"></label>
                    <kendo-textbox for="PenyelesaianHeader.JenisPenyelesaian" style="width: 100%;" />
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.NomorBukti"></label>
                    <kendo-textbox for="PenyelesaianHeader.NomorBukti" style="width: 100%;" readonly="isEditMode" />
                </div>
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.KodeVoucherAcc"></label>
                    <kendo-textbox for="PenyelesaianHeader.KodeVoucherAcc" style="width: 100%;" />
                </div>
            </div>
        </fieldset>
        
        <hr/>

        <fieldset>
            <div class="row">
                <div class="form-group col-sm-4">
                    <label asp-for="PenyelesaianHeader.Tanggal"></label>
                    <kendo-datepicker for="PenyelesaianHeader.Tanggal" style="width: 100%;" />
                </div>
                <div class="form-group col-sm-4">
                    <label asp-for="PenyelesaianHeader.MataUang"></label>
                    <kendo-combobox for="PenyelesaianHeader.MataUang"
                                    style="width: 100%;"
                                    datatextfield="Text"
                                    datavaluefield="Value"
                                    bind-to="ViewBag.MataUangOptions"
                                    filter="FilterType.Contains"
                                    placeholder="Pilih Mata Uang...">
                    </kendo-combobox>
                </div>
                <div class="form-group col-sm-4">
                    <label asp-for="PenyelesaianHeader.KodeAkun"></label>
                    <kendo-combobox for="PenyelesaianHeader.KodeAkun"
                                    style="width:100%;"
                                    datatextfield="Text"
                                    datavaluefield="Value"
                                    bind-to="ViewBag.KodeAkunOptions"
                                    filter="FilterType.Contains"
                                    placeholder="Pilih Akun...">
                    </kendo-combobox>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.TotalOrg">Total Original</label>
                    <kendo-numerictextbox for="PenyelesaianHeader.TotalOrg" format="n2" style="width: 100%;" />
                </div>
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.TotalRp">Total Dalam Rupiah</label>
                    <kendo-numerictextbox for="PenyelesaianHeader.TotalRp" format="n2" style="width: 100%;" />
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-12">
                    <label asp-for="PenyelesaianHeader.Keterangan"></label>
                    <kendo-textarea for="PenyelesaianHeader.Keterangan" name="PenyelesaianHeader.Keterangan" style="width: 100%;" rows="3"></kendo-textarea>
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-4">
                    <label asp-for="PenyelesaianHeader.FlagPosting"></label>
                    <div>
                        <input type="checkbox" id="FlagPostingCheckbox" class="k-checkbox" 
                               @(Model.PenyelesaianHeader?.FlagPosting == true ? "checked" : "") disabled />
                        <label class="k-checkbox-label" for="FlagPostingCheckbox">Posted</label>
                    </div>
                </div>
            </div>
        </fieldset>

        <hr/>
        
        <fieldset>
            <legend>Audit Trail</legend>
            <div class="row">
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.TanggalInput"></label>
                    <kendo-datepicker for="PenyelesaianHeader.TanggalInput" style="width: 100%;" readonly="true" />
                </div>
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.KodeUserInput"></label>
                    <kendo-textbox for="PenyelesaianHeader.KodeUserInput" style="width: 100%;" readonly="true" />
                </div>
            </div>
            <div class="row">
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.TanggalUpdate"></label>
                    <kendo-datepicker for="PenyelesaianHeader.TanggalUpdate" style="width: 100%;" readonly="true" />
                </div>
                <div class="form-group col-sm-6">
                    <label asp-for="PenyelesaianHeader.KodeUserUpdate"></label>
                    <kendo-textbox for="PenyelesaianHeader.KodeUserUpdate" style="width: 100%;" readonly="true" />
                </div>
            </div>
        </fieldset>
    </form>
    <div style="text-align: right; margin-top: 10px;">
        <button type="button" id="btn-save-header" onclick="onSaveHeaderAndProceed()" class="btn btn-success">Simpan Header & Lanjutkan</button>
    </div>

    <hr>
   <form id="NewPaymentForm">
          <input  id="NomorBuktiHeader" name="NomorBukti" value="@Model.PenyelesaianHeader?.NomorBukti" />
        <input type="hidden"  asp-for="No" />
        <div class="row">
           <div class="form-group col-sm-2">
                <label asp-for="FlagPembayaran"></label>
                <div>
                    <kendo-dropdownlist for="FlagPembayaran"
                                        style="width: 100%;"
                                        datatextfield="Text"
                                        datavaluefield="Value"
                                        bind-to="ViewBag.FlagPembayaranOptions">
                        
                    </kendo-dropdownlist>
                    <span asp-validation-for="FlagPembayaran" class="text-danger"></span>
                </div>
            </div>
            <div class="form-group col-sm-3" id="notaField"> 
                <label asp-for="NoNota"></label>
                <div class="input-group" style=" display: flex;     width: 100%;     flex-direction: row;     flex-wrap: nowrap;     align-content: center;     justify-content: center;     align-items: center; ">
                    <kendo-textbox for="NoNota" style="width:100%;" readonly="true" />
                    <div class="input-group-append">
                        <button type="button" class="btn btn-info" onclick="openPilihNotaWindow()">Select</button>
                    </div>
                </div>
            </div>

            @(Html.Kendo().Window()
                .Name("PilihNotaWindow")
                .Title("Pilih Nota Produksi")
                .Width(800)
                .Modal(true)
                .Visible(false)
                .Draggable(true)
            )


            <div class="form-group col-sm-2" id="akunField" style="display:none;">
                <label asp-for="KodeAkun"></label>
                <div>
                    <kendo-combobox for="KodeAkun"
                                    style="width:100%;"
                                    datatextfield="Text"
                                    datavaluefield="Value"
                                    bind-to="ViewBag.KodeAkunOptions"
                                    filter="FilterType.Contains"
                                    placeholder="Pilih Akun..." value="@Model.PenyelesaianHeader?.KodeAkun" >
                    </kendo-combobox>
                    <span asp-validation-for="KodeAkun" class="text-danger"></span>
                </div>
            </div>
            <div class="form-group col-sm-2">
                    <label asp-for="KodeMataUang"></label>
                    <div>
                        <kendo-combobox for="KodeMataUang"
                                        style="width: 100%;"
                                        datatextfield="Text"
                                        datavaluefield="Value"
                                        bind-to="ViewBag.MataUangOptions"
                                        filter="FilterType.Contains"
                                        placeholder="Pilih ..."
                                    > 
                        </kendo-combobox>
                        <span asp-validation-for="KodeMataUang" class="text-danger"></span>
                    </div>
            </div>
           
            <div class="form-group col-sm-3">
                <label asp-for="TotalBayarOrg"></label>
                <kendo-numerictextbox for="TotalBayarOrg" format="n0" style="width:100%;" />
            </div>

            <div class="form-group col-sm-3">
                <label asp-for="TotalBayarRp"></label>
                <kendo-numerictextbox for="TotalBayarRp" format="n0" style="width:100%;" />
            </div>

            <div class="form-group col-sm-2">
                 <label asp-for="DebetKredit"></label>
                <div>
                    <kendo-dropdownlist for="DebetKredit"
                                        style="width: 100%;"
                                        datatextfield="Text"
                                        datavaluefield="Value"
                                        bind-to="ViewBag.DebetKreditOptions">
                        
                    </kendo-dropdownlist>
                    <span asp-validation-for="DebetKredit" class="text-danger"></span>
                </div>
            </div>
        </div>
    </form>
    <div style="display: flex;gap: 10px;justify-content: flex-end;">
    <button type="button" id="btn-cancel-edit" class="btn btn-secondary" style="display: none;" onclick="clearPaymentForm()">Cancel</button>
    <button type="button" onclick="onSavePembayaran()" class="btn btn-primary">Simpan Pembayaran</button>
    </div>
    <hr/>
    <script>
    function getNoBuktiForDetailGrid() {
         return { NoBukti: $("#NoBukti").val() };
    }

    $(document).ready(function () {
        // Ambil instance dropdownlist dari Kendo
        var ddl = $("#FlagPembayaran").data("kendoDropDownList");

        // Daftarkan event change
        ddl.bind("change", function (e) {
            var value = this.value();
            if (value && value.toUpperCase() === "AKUN") {
                $("#akunField").show();
                $("#notaField").hide();
            } else if(value && value.toUpperCase() === "NOTA"){
                $("#notaField").show();
                $("#akunField").hide();
            } else {
                $("#notaField").hide();
                $("#akunField").hide();
            }
        });
    });

    
</script>
    

    @(Html.Kendo().Grid<EntriPenyelesaianPiutangDto>() // <-- Gunakan DTO yang benar
        .Name("DetailPembayaranGrid")
        .DataSource(ds => ds.Ajax()
            .Read(read => read.Action("GetDetailPembayaran", "EntriPenyelesaianPiutang")
                .Data("getNoBuktiForDetailGrid"))
        )
        .Columns(cols => {
            cols.Bound(c => c.No).Title("No.");
            cols.Bound(c => c.FlagPembayaran).Title("Flag Pembayaran");
            cols.Bound(c => c.NoNota).Title("Nomor Nota");
            cols.Bound(c => c.KodeAkun).Title("Kode Akun");
            cols.Bound(c => c.KodeMataUang).Title("Kode Mata Uang");
            cols.Bound(c => c.TotalBayarOrg).Format("{0:n0}");
            cols.Bound(c => c.TotalBayarRp).Format("{0:n0}");
            cols.Bound(c => c.DebetKredit).Title("D/K");
            cols.Command(command => {
            command.Custom("EditDetail").Text("Edit").Click("onEditPembayaran");
            command.Custom("DeleteDetail").Text("Delete").Click("onDeletePembayaran");
        }).Title("Action").Width(180);
        })
        .NoRecords(nr => nr.Template("Belum ada pembayaran")).Pageable(pager => pager.Refresh(true))
                .Sortable()
                .Filterable()
                .Scrollable()
                .Resizable(a=>a.Columns(true))
                .Events(ev => ev.DataBound("updateGridFooter"))
    )
</div>
<div class="window-footer" style=" font-weight: bold;    display: flex;     justify-content: center;     flex-direction: row;     flex-wrap: nowrap;     align-content: center;     align-items: center; ">
    <div style="padding-right: 20px;font-size: 13px;">
           <span>Total Bukti (Rp): </span>
            <span id="voucherTotal">Rp. @Model.PenyelesaianHeader?.TotalRp?.ToString("N0")</span>
            
            <span style="margin-left: 20px;">Total Penyelesaian: Rp. </span>
            <span id="pembayaranTotal" style="color: green;">0</span>
        </div>
</div>


