@using Kendo.Mvc.UI
@using Kendo.Mvc.TagHelpers
@using Microsoft.Extensions.Configuration
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Kendo.Mvc

@{
    Layout = "~/Modules/Shared/_Layout.cshtml";
    ViewData["Title"] = "Laporan Buku Besar 117";
}
<script src="~/Modules/LaporanBukuBesar117/JS/LaporanBukuBesar117.index.js"></script>

<style>
    .filter-section { display: flex; align-items: center; margin-bottom: 15px; }
    .filter-label { font-weight: bold; width: 140px; min-width: 140px; white-space: nowrap; margin-right: 15px; }
    .filter-input-group { display: flex; align-items: center; gap: 10px; }
    .sd-text { font-weight: 600; margin: 0 5px; }
</style>

<nav aria-label="breadcrumb">
   <ol class="breadcrumb" style="background: white;">
        <li class="breadcrumb-item"><a href="#">Accounting</a></li>
        <li class="breadcrumb-item active" aria-current="page">Laporan Buku Besar</li>
    </ol>
</nav>

<div class="flat-box filter-box">
    <div class="flat-box-content filter-container">
        
        <div class="filter-section">
            <label class="filter-label">Kode Cabang :</label>
             <input class="k-textbox" value="@ViewBag.UserCabangText" readonly style="width:300px; background-color: #e9ecef;" />
             <input type="hidden" id="KodeCabang" value="@ViewBag.UserCabangValue" />
        </div>

        <div class="filter-section">
            <label class="filter-label">Periode :</label>
            <div class="filter-input-group">
                @(Html.Kendo().DatePicker().Name("tgl1").Format("dd-MM-yyyy").HtmlAttributes(new { style = "width:120px;" }))
                <span class="sd-text">s/d</span>
                @(Html.Kendo().DatePicker().Name("tgl2").Format("dd-MM-yyyy").HtmlAttributes(new { style = "width:120px;" }))
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label">Kode Akun :</label>
            <div class="filter-input-group">
                @(Html.Kendo().ComboBox()
                    .Name("AkunAwal")
                    .Placeholder("Ketik kode/nama akun...")
                    .DataTextField("Display")
                    .DataValueField("Kode")
                    .Filter(FilterType.Contains) // Filter contains
                    .MinLength(2) // Baru cari setelah user ketik 2 huruf (Biar gak request pas kosong)
                    .AutoBind(false) // PENTING: Jangan load data saat page load!
                    .Suggest(true)
                    .HtmlAttributes(new { style = "width:250px;" })
                    .DataSource(source => { 
                        source.Read(read => { 
                            read.Action("GetCoaList", "LaporanBukuBesar117"); 
                            // Kendo otomatis kirim parameter bernama 'text' saat user ngetik
                        })
                        .ServerFiltering(true); // PENTING: Filter dilakukan di Controller, bukan di Browser
                    })
                )

                <span class="sd-text">s/d</span>

                @(Html.Kendo().ComboBox()
                    .Name("AkunAkhir")
                    .Placeholder("Ketik kode/nama akun...")
                    .DataTextField("Display")
                    .DataValueField("Kode")
                    .Filter(FilterType.Contains)
                    .MinLength(2)
                    .AutoBind(false) // PENTING
                    .Suggest(true)
                    .HtmlAttributes(new { style = "width:250px;" })
                    .DataSource(source => { 
                        source.Read(read => { 
                            read.Action("GetCoaList", "LaporanBukuBesar117"); 
                        })
                        .ServerFiltering(true); // PENTING
                    })
                )
            </div>
        </div>

        <div class="filter-section">
             <button id="btnSearch" class="k-button k-primary" style="border-radius:6px; width:120px;" onclick="generateBukuBesar117()">
                <span class='k-icon k-i-search'></span> Cari
            </button>
        </div>

    </div>
</div>


<script>
function generateBukuBesar117() {
        var kodeCabang = $("#KodeCabang").val();
        var tgl1 = kendo.toString($("#tgl1").data("kendoDatePicker").value(), "yyyy-MM-dd");
        var tgl2 = kendo.toString($("#tgl2").data("kendoDatePicker").value(), "yyyy-MM-dd");
        var akun1 = $("#AkunAwal").data("kendoComboBox").value();
        var akun2 = $("#AkunAkhir").data("kendoComboBox").value();

        if (!tgl1 || !tgl2) {
            alert("Periode tanggal harus diisi!");
            return;
        }

        var payload = {
            KodeCabang: kodeCabang,
            PeriodeAwal: tgl1,
            PeriodeAkhir: tgl2,
            AkunAwal: akun1,
            AkunAkhir: akun2
        };
        
        // Panggil Controller LaporanBukuBesar117
        $.ajax({
            url: '/LaporanBukuBesar117/GenerateReport',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (res) {
                if (res.Status === "OK") {
                    window.open("/Reports/" + res.Data + "/LaporanBukuBesar117.pdf", "_blank");
                } else {
                    alert("Error: " + res.Message);
                }
            },
            error: function () {
                alert("Terjadi kesalahan server");
            }
        });
    }
</script>