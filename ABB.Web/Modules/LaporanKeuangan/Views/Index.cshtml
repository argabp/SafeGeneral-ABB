@using Kendo.Mvc.UI
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Kendo.Mvc

@{
    Layout = "~/Modules/Shared/_Layout.cshtml";
    ViewData["Title"] = "Laporan Keuangan";
}

<style>
    .filter-box { background: #fff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
</style>

<nav aria-label="breadcrumb">

   <ol class="breadcrumb" style="background: white;">

        <li class="breadcrumb-item"><a href="#">Accounting</a></li>

        <li class="breadcrumb-item active" aria-current="page">Laporan Keuangan</li>

    </ol>

</nav>
<div class="flat-box">
    <div class="flat-box-title">Filter Laporan</div>
    <div class="flat-box-content">
        <div class="row">
            <div class="col-md-4">
                <label>Jenis Laporan</label>
                @(Html.Kendo().DropDownList().Name("TipeLaporan")
                    .BindTo(new List<string>() { "NERACA", "LABARUGI" })
                    .HtmlAttributes(new { style = "width: 100%" }))
            </div>
            <div class="col-md-4">
                <label>Per Tanggal</label>
                @(Html.Kendo().DatePicker().Name("PerTanggal")
                    .Value(DateTime.Now).Format("dd MMMM yyyy")
                    .HtmlAttributes(new { style = "width: 100%" }))
            </div>
            <div class="col-md-4" style="display:flex; align-items:flex-end;">
                <button class="btn btn-primary btn-block" onclick="onGenerateClick()">
                    <i class="fa fa-print"></i> Generate PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function onGenerateClick() {
        var tipe = $("#TipeLaporan").val();
        var tanggal = $("#PerTanggal").data("kendoDatePicker").value();

        if (!tanggal) {
            alert("Silakan pilih tanggal terlebih dahulu.");
            return;
        }
        
        if (tipe !== "NERACA") {
            alert("Laporan Laba Rugi belum tersedia.");
            return;
        }

        var formattedDate = kendo.toString(tanggal, "yyyy-MM-dd");

        // Data yang dikirim ke Controller
        var formData = {
            TipeLaporan: tipe,
            PerTanggal: formattedDate
        };

        // UI Loading sederhana (opsional)
        var btn = $("button.btn-primary");
        var originalText = btn.html();
        btn.html('<i class="fa fa-spinner fa-spin"></i> Processing...').prop("disabled", true);

        $.ajax({
            url: '/LaporanKeuangan/GenerateReport',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (response) {
                // Balikkan tombol
                btn.html(originalText).prop("disabled", false);

                if (response.Status === "OK") {
                    // [LOGIC SAMA KAYAK JURNAL HARIAN]
                    // Buka PDF di tab baru. 
                    // Asumsi ReportGenerator menyimpan file di: /Reports/{UserID}/NamaFile.pdf
                    window.open("/Reports/" + response.Data + "/LaporanNeraca.pdf", '_blank');
                } else {
                    alert("Gagal membuat laporan: " + response.Message);
                }
            },
            error: function () {
                btn.html(originalText).prop("disabled", false);
                alert("Terjadi kesalahan koneksi saat membuat laporan.");
            }
        });
    }
</script>