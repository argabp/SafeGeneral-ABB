@using Kendo.Mvc.UI
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Kendo.Mvc

@{
    Layout = "~/Modules/Shared/_Layout.cshtml";
    ViewData["Title"] = "Laporan Keuangan";
    int currentYear = DateTime.Now.Year;
}

<style>
    .flat-box {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
        overflow: hidden;
    }
    .flat-box-content { padding: 25px; }
    label { font-weight: 600; font-size: 12px; color: #555; margin-bottom: 5px; display: block;}
    .btn-generate { background-color: var(--primary-blue); color: white; font-weight: bold; }
    .btn-generate:hover{
        color: grey;
    }
</style>

<nav aria-label="breadcrumb">
   <ol class="breadcrumb" style="background: transparent; padding-left: 0;">
        <li class="breadcrumb-item"><a href="#">Accounting</a></li>
        <li class="breadcrumb-item active">Laporan Keuangan</li>
    </ol>
</nav>

<div class="flat-box">
    <div class="flat-box-content">
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label>Jenis Laporan</label>
                    @(Html.Kendo().DropDownList().Name("TipeLaporan")
                        .BindTo(new List<string>() { "NERACA", "LABARUGI","ARUSKAS" })
                        .HtmlAttributes(new { style = "width: 100%" }))
                </div>
            </div>

            <div class="col-md-2">
                <div class="form-group">
                    <label>Periode</label>
                    @(Html.Kendo().DropDownList().Name("JenisPeriode")
                        .BindTo(new List<string>() { "TAHUNAN" })
                        .Events(e => e.Change("onPeriodeChange")) // Trigger saat ganti
                        .HtmlAttributes(new { style = "width: 100%" }))
                </div>
            </div>

           

            <div class="col-md-2">
                <div class="form-group">
                    <label>Tahun</label>
                    @(Html.Kendo().NumericTextBox<int>().Name("Tahun")
                        .Format("#")
                        .Min(2000).Max(2099)
                        .Value(currentYear)
                        .HtmlAttributes(new { style = "width: 100%" }))
                </div>
            </div>

            <div class="col-md-3" style="display:flex;align-items: center;">
                <button class="btn btn-block btn-generate" onclick="onGenerateClick()">
                    <i class="fa fa-print"></i> Generate PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Event saat dropdown Periode berubah
    function onPeriodeChange() {
        var periode = $("#JenisPeriode").val();
        
        if (periode === "TAHUNAN") {
            $("#divBulan").hide(); // Sembunyikan Bulan
        } else {
            $("#divBulan").show(); // Tampilkan Bulan
        }
    }

    function onGenerateClick() {
        var tipeLaporan = $("#TipeLaporan").val();
        var jenisPeriode = $("#JenisPeriode").val();
        var tahun = $("#Tahun").val();
        
        // Logika Bulan
        var bulan = 12; // Default 12 jika TAHUNAN (Biar keambil Jan-Des)
        
        if (jenisPeriode === "BULANAN") {
            bulan = $("#Bulan").val();
        }

        // Validasi Sederhana
        if (!tahun) {
            alert("Harap isi Tahun.");
            return;
        }

        // Siapkan Data DTO Baru
        var formData = {
            TipeLaporan: tipeLaporan,
            JenisPeriode: jenisPeriode,
            Bulan: parseInt(bulan),
            Tahun: parseInt(tahun)
        };

        var btn = $("button.btn-generate");
        var originalText = btn.html();
        btn.html('<i class="fa fa-spinner fa-spin"></i> Loading...').prop("disabled", true);

        $.ajax({
            url: '/LaporanKeuangan/GenerateReport',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (response) {
                btn.html(originalText).prop("disabled", false);

                if (response.Status === "OK") {
                    var userId = response.Data;
                    var fileName = response.Filename; // Contoh: "LaporanLabaRugi.pdf"
                    
                    var url = "/Reports/" + userId + "/" + fileName;
                    
                    window.open(url, '_blank');
                } else {
                    alert("Gagal: " + response.Message);
                }
            },
            error: function () {
                btn.html(originalText).prop("disabled", false);
                alert("Error koneksi server.");
            }
        });
    }

    $(document).ready(function() {
        // Trigger sekali di awal untuk set state awal
        onPeriodeChange();
    });
</script>