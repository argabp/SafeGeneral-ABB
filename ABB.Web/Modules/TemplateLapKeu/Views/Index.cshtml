@using Kendo.Mvc.UI
@using Kendo.Mvc.TagHelpers
@using ABB.Application.TemplateLapKeus.Queries
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Kendo.Mvc

@{
    Layout = "~/Modules/Shared/_Layout.cshtml";
    ViewData["Title"] = "Template Laporan Keuangan";
}

<script src="~/Modules/TemplateLapKeu/JS/templatelapkeu.index.js"></script>

<style>
    .div-box { padding-bottom: 1em; }
    .swal2-container { z-index: 10050 !important; }
     .breadcrumb-item + .breadcrumb-item::before {
        content: ">"; 
        padding: 0 .5rem; 
    }
</style>

<nav aria-label="breadcrumb">
   <ol class="breadcrumb" style="background: white; ">
        <li class="breadcrumb-item"><a href="#">Accounting</a></li>
        <li class="breadcrumb-item active" aria-current="page">Template Laporan Keuangan</li>
    </ol>
</nav>

<div class="flat-box">
    <div class="flat-box-title ">
       Daftar Template
        <div class="pullright-flex">
            <input type="text" class="search-field-top " id="SearchKeyword" placeholder="Cari Deskripsi/Rumus..."/>
            <button class="flat-btn-primary" onclick="onAddClick()">Tambah Template</button>
        </div>
    </div>

    <div class="flat-box-content">
        
        @* --- IMPLEMENTASI TABSTRIP --- *@
        @(Html.Kendo().TabStrip()
            .Name("tabStripTemplate")
            .Animation(animation => animation.Open(effect => effect.Fade(FadeDirection.In)))
            .Items(items =>
            {
                // --- TAB 1: NERACA ---
                items.Add().Text("Neraca").Selected(true)
                    .Content(@<text>
                        <div class="div-box">
                            @(Html.Kendo().Grid<TemplateLapKeuDto>()
                                .Name("GridNeraca") // ID Grid Unik
                                .DataSource(dataSource => dataSource.Ajax()
                                    .Read(read => read.Action("GetGridData", "TemplateLapKeu").Data("getFilterNeraca")) // Filter Khusus Neraca
                                    .Model(model => model.Id(p => p.Id))
                                    .PageSize(20)
                                    .Sort(sort => sort.Add("Urutan").Ascending())
                                )
                                .Columns(columns =>
                                {
                                    columns.Bound(c => c.Urutan).Title("No Urut").Width(80).Sortable(true);
                                    // TipeLaporan bisa dihide karena sudah ada di Tab, tapi ditampilkan juga tidak apa-apa
                                    columns.Bound(col => col.TipeLaporan).Title("Tipe Lap").Width(120).Hidden(true); 
                                    columns.Bound(col => col.TipeBaris).Title("Tipe Baris").Width(120);
                                    columns.Bound(col => col.Deskripsi).Title("Deskripsi").Width(300);
                                    columns.Bound(col => col.Rumus).Title("Rumus / Akun").Width(200);
                                    columns.Bound(col => col.Level).Title("Level").Width(80).HtmlAttributes(new { style = "text-align:center" });
                                    columns.Command(command =>
                                    {
                                        command.Custom("EditTemplate").Text(" Edit ").IconClass("fa fa-edit").Click("onEditClick");
                                        command.Custom("DeleteTemplate").Text(" Hapus ").IconClass("fa fa-trash").Click("onDeleteClick");
                                    }).Width(180).Title("Aksi").Locked(true);
                                })
                                .Pageable(pager => pager.Refresh(true).PageSizes(true)).Sortable().Filterable().Scrollable().Height(500).Resizable(a => a.Columns(true))
                            )
                        </div>
                    </text>);

                // --- TAB 2: LABA RUGI ---
                items.Add().Text("Laba Rugi")
                    .Content(@<text>
                        <div class="div-box">
                            @(Html.Kendo().Grid<TemplateLapKeuDto>()
                                .Name("GridLabaRugi") // ID Grid Unik
                                .DataSource(dataSource => dataSource.Ajax()
                                    .Read(read => read.Action("GetGridData", "TemplateLapKeu").Data("getFilterLabaRugi")) // Filter Khusus Laba Rugi
                                    .Model(model => model.Id(p => p.Id))
                                    .PageSize(20)
                                    .Sort(sort => sort.Add("Urutan").Ascending())
                                )
                                .Columns(columns =>
                                {
                                    columns.Bound(c => c.Urutan).Title("No Urut").Width(80).Sortable(true);
                                    columns.Bound(col => col.TipeLaporan).Title("Tipe Lap").Width(120).Hidden(true);
                                    columns.Bound(col => col.TipeBaris).Title("Tipe Baris").Width(120);
                                    columns.Bound(col => col.Deskripsi).Title("Deskripsi").Width(300);
                                    columns.Bound(col => col.Rumus).Title("Rumus / Akun").Width(200);
                                    columns.Bound(col => col.Level).Title("Level").Width(80).HtmlAttributes(new { style = "text-align:center" });
                                    columns.Command(command =>
                                    {
                                        command.Custom("EditTemplate").Text(" Edit ").IconClass("fa fa-edit").Click("onEditClick");
                                        command.Custom("DeleteTemplate").Text(" Hapus ").IconClass("fa fa-trash").Click("onDeleteClick");
                                    }).Width(180).Title("Aksi").Locked(true);
                                })
                                .Pageable(pager => pager.Refresh(true).PageSizes(true)).Sortable().Filterable().Scrollable().Height(500).Resizable(a => a.Columns(true))
                            )
                        </div>
                    </text>);

                // --- TAB 3: ARUS KAS ---
                items.Add().Text("Arus Kas")
                    .Content(@<text>
                        <div class="div-box">
                            @(Html.Kendo().Grid<TemplateLapKeuDto>()
                                .Name("GridArusKas") // ID Grid Unik
                                .DataSource(dataSource => dataSource.Ajax()
                                    .Read(read => read.Action("GetGridData", "TemplateLapKeu").Data("getFilterArusKas")) // Filter Khusus Arus Kas
                                    .Model(model => model.Id(p => p.Id))
                                    .PageSize(20)
                                    .Sort(sort => sort.Add("Urutan").Ascending())
                                )
                                .Columns(columns =>
                                {
                                    columns.Bound(c => c.Urutan).Title("No Urut").Width(80).Sortable(true);
                                    columns.Bound(col => col.TipeLaporan).Title("Tipe Lap").Width(120).Hidden(true);
                                    columns.Bound(col => col.TipeBaris).Title("Tipe Baris").Width(120);
                                    columns.Bound(col => col.Deskripsi).Title("Deskripsi").Width(300);
                                    columns.Bound(col => col.Rumus).Title("Rumus / Akun").Width(200);
                                    columns.Bound(col => col.Level).Title("Level").Width(80).HtmlAttributes(new { style = "text-align:center" });
                                    columns.Command(command =>
                                    {
                                        command.Custom("EditTemplate").Text(" Edit ").IconClass("fa fa-edit").Click("onEditClick");
                                        command.Custom("DeleteTemplate").Text(" Hapus ").IconClass("fa fa-trash").Click("onDeleteClick");
                                    }).Width(180).Title("Aksi").Locked(true);
                                })
                                .Pageable(pager => pager.Refresh(true).PageSizes(true)).Sortable().Filterable().Scrollable().Height(500).Resizable(a => a.Columns(true))
                            )
                        </div>
                    </text>);
            })
        )

        @* Window untuk Form Add/Edit *@
        @(Html.Kendo().Window()
            .Name("TemplateWindow")
            .Title("Form Template Laporan")
            .Width(600)
            .Modal(true)
            .Visible(false)
            .Draggable(true)
        )
    </div>
</div>

<script>
    // --- FUNGSI FILTER UNTUK MASING-MASING TAB ---
    
    // 1. Filter Neraca
    function getFilterNeraca() {
        return {
            searchKeyword: $("#SearchKeyword").val(),
            tipeLaporan: "NERACA" // Value ini harus sama dengan yang di DB
        };
    }

    // 2. Filter Laba Rugi
    function getFilterLabaRugi() {
        return {
            searchKeyword: $("#SearchKeyword").val(),
            tipeLaporan: "LABARUGI" // Sesuaikan dengan value DB (misal: "LR" atau "LABARUGI")
        };
    }

    // 3. Filter Arus Kas
    function getFilterArusKas() {
        return {
            searchKeyword: $("#SearchKeyword").val(),
            tipeLaporan: "ARUSKAS" // Sesuaikan dengan value DB
        };
    }

    $(document).ready(function () {
        // Event listener pencarian
        $("#SearchKeyword").on("keyup", function() {
            // Logika Search: Cek Tab mana yang aktif, lalu refresh grid di dalamnya
            var tabStrip = $("#tabStripTemplate").data("kendoTabStrip");
            var activeTab = tabStrip.select().index();

            if (activeTab === 0) {
                $("#GridNeraca").data("kendoGrid").dataSource.read();
            } else if (activeTab === 1) {
                $("#GridLabaRugi").data("kendoGrid").dataSource.read();
            } else if (activeTab === 2) {
                $("#GridArusKas").data("kendoGrid").dataSource.read();
            }
        });
    });
</script>