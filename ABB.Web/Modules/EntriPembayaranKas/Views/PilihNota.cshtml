@using ABB.Application.EntriPembayaranKass.Queries 
@using ABB.Application.InquiryNotaProduksis.Queries 
@model ABB.Web.Modules.EntriPembayaranKas.Models.EntriPembayaranKasViewModel
@using Kendo.Mvc.UI
@using Newtonsoft.Json
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Kendo.Mvc

<!-- <script src="~/Modules/EntriPembayaranKas/JS/entripembayarankas.index.js"></script> -->

<script>
    // Variable untuk data source akun (jika masih dipakai)
    var coaDataSource = @Html.Raw(JsonConvert.SerializeObject(ViewBag.KodeAkunOptions ?? new List<SelectListItem>()));

    // 1. FUNGSI DATABOUND (Style Grid)
    function onPilihNotaGridDataBound(e) {
        var grid = e.sender;
        var items = grid.items(); 
        var totalItems = grid.dataSource.total();
        var pager = grid.pager;

        // --- LOGIC PAGINATION ALL (Bawaan Kamu) ---
        if (pager) {
            var pageSizeDropDown = pager.element.find("select[data-role='dropdownlist']").data("kendoDropDownList");
            if (pageSizeDropDown) {
                var ds = pageSizeDropDown.dataSource.data();
                var found = false;
                for (var i = 0; i < ds.length; i++) {
                    var currentValue = ds[i].value;
                    if (currentValue == 50000 || (currentValue > 500 && currentValue == totalItems)) { 
                        ds[i].value = totalItems; 
                        ds[i].text = "All"; 
                        found = true;
                        break;
                    }
                }
                if (found) {
                    pageSizeDropDown.refresh();
                    if (pageSizeDropDown.value() == totalItems) {
                        pageSizeDropDown.span.text("All");
                    }
                }
            }
        }
        // -------------------------------------------

        // --- LOGIC BARU: AUTO HITUNG KURS ---
        items.each(function (index, row) {
            var dataItem = grid.dataItem(row);
            var $row = $(row);
            
            var $inputOrg = $row.find('.total-org-input');
            var $inputRp = $row.find('.total-rp-input');
            
            var saldoOrg = parseFloat(dataItem.saldo) || 0;
            var kodeMtu = dataItem.kd_mtu; 
            
            // [PERBAIKAN DISINI] Ganti .tgl_prod menjadi .date
            var rawDate = dataItem.date; 
            
            var formattedDate = "";

            if (rawDate) {
                var dateObj = kendo.parseDate(rawDate);
                if (dateObj) {
                    formattedDate = kendo.toString(dateObj, "yyyy-MM-dd");
                }
            }
            
            // Fallback: Kalau tanggal nota kosong, baru pakai tanggal voucher
            if (!formattedDate) {
                var tglVoc = $("#TangVoc").val(); 
                if(tglVoc) {
                    var parts = tglVoc.split(" ")[0].split("/"); // dd/MM/yyyy
                    if(parts.length === 3) {
                        formattedDate = parts[2] + '-' + parts[1] + '-' + parts[0];
                    }
                }
            }

            // 2. Set Nilai Default Input Original (Saldo)
            if($inputOrg.val() == "" || $inputOrg.val() == 0) {
                $inputOrg.val(saldoOrg);
            }

            // 3. Logika Rupiah Otomatis
            if (kodeMtu && kodeMtu.trim() === '001') {
                // IDR
                $inputRp.val(saldoOrg.toFixed(2));
                $inputRp.data('kurs', 1); 
            } 
            else if (kodeMtu && formattedDate && saldoOrg > 0) {
                // VALAS -> Panggil API Kurs pakai Tgl Nota (formattedDate)
                var url = `/EntriPembayaranKas/GetKurs?kodeMataUang=${kodeMtu}&tanggalVoucher=${formattedDate}`;
                
                $.ajax({
                    type: "GET",
                    url: url,
                    success: function (response) {
                        if (response && response.nilai_kurs) {
                            var kurs = response.nilai_kurs;
                            var totalRupiah = saldoOrg * kurs;
                            
                            // Isi nilai Rupiah
                            $inputRp.val(totalRupiah.toFixed(2));
                            
                            // Simpan nilai kurs di data attribute
                            $inputRp.data('kurs', kurs);
                        }
                    },
                    error: function() {
                        console.error("Gagal ambil kurs untuk nota: " + dataItem.no_nd);
                    }
                });
            }
        });
    }

    // 2. FUNGSI FILTER (PENTING: JANGAN DI-COMMENT)
    // Fungsi ini dipanggil otomatis oleh Grid saat .read()
    function getNotaProduksiSearchFilter() {
        return {
            // Ambil nilai dari TextBox Search
            searchKeyword: $("#PilihNotaSearchKeyword").val(), 
            
            // Ambil nilai dari Dropdown Jenis Asset
            jenisAsset: $("#JenisAsset").val(),
            StartDate: $("#StartDate").val(),
            EndDate: $("#EndDate").val()
        };
    }

    // 3. FUNGSI TOMBOL CARI
    function onSearchClick() {
        // Paksa Grid untuk refresh data (baca ulang ke controller)
        var grid = $("#PilihNotaGrid").data("kendoGrid");
        grid.dataSource.page(1); // Reset ke halaman 1
        grid.dataSource.read();  // Panggil Controller
    }

    // 4. ENTER KEY (Supaya pas ketik enter langsung cari)
    $(function() {
        $("#PilihNotaSearchKeyword").on("keyup", function(e) {
            if (e.key === "Enter") {
                onSearchClick();
            }
        });
    });
</script>
<div class="p-2">

        <!-- Label Periode -->
            <label for="StartDate"><b>Periode :</b></label>

            <!-- DatePicker Dari -->
            @(Html.Kendo().DatePicker()
                .Name("StartDate")
                .HtmlAttributes(new { style = "width:150px;" })
                .Format("dd-MM-yyyy")
            )

            <span class="date-separator">s/d</span>

            <!-- DatePicker Sampai -->
            @(Html.Kendo().DatePicker()
                .Name("EndDate")
                .HtmlAttributes(new { style = "width:150px;" })
                .Format("dd-MM-yyyy")
            )

     <!-- Label Jenis Asset -->
        <label for="JenisAsset" style="margin-left:15px;"><b>Jenis Ass :</b></label>

        <!-- Dropdown Jenis Asset -->
        @(Html.Kendo().ComboBox()
            .Name("JenisAsset")
            .Placeholder("Pilih ...")
            .DataTextField("NamaJenisAsset")
            .DataValueField("KodeJenisAsset")
            .Filter("contains") // bisa mengetik untuk filter
            .Suggest(true) // auto-suggest saat ketik
            .DataSource(source => {
                source.Read(read => {
                    read.Action("GetJenisAssetList", "InquiryNotaProduksi");
                });
            })
            .HtmlAttributes(new { style = "width:250px;" })
        )


        <!-- Tombol Cari -->
        @(Html.Kendo().Button()
            .Name("btnSearch")
            .Content("<span class='k-icon k-i-search'></span> Cari")
            .HtmlAttributes(new { @class = "k-primary", style = "border-radius:6px; margin-left:10px;" })
            .Events(e => e.Click("onSearchClick"))
        )
</div>


<div class="p-2">
    <input type="text" class="k-textbox" id="PilihNotaSearchKeyword" 
           placeholder="Cari berdasarkan No. Nota atau Nama..." style="width: 100%;">
</div>


@(Html.Kendo().Grid<InquiryNotaProduksiDto>()
    .Name("PilihNotaGrid")
    .NoRecords(n => n.Template("<div style='padding:5px;'>Data tidak ditemukan</div>"))
    .AutoBind(false)
    .DataSource(dataSource => dataSource.Ajax()
        .Read(read => read
            .Action("GetNotaProduksi", "EntriPembayaranKas")
            .Data("getNotaProduksiSearchFilter")
        )
    )
    .Columns(columns =>
    {
        columns.Select().Width(50);
        
        columns.Bound(c => c.no_nd).Title("Nomor Nota").Width(200);
        columns.Bound(c => c.no_pl).Title("Nomor Polis").Width(200);
        columns.Bound(c => c.saldo).Title("Saldo").Format("{0:n2}").Width(150);
        
        // --- [PERUBAHAN 2: Auto Fill Saldo] ---
        columns.Template(
            "<input type='number' class='k-textbox total-org-input' " + 
            "value='#= saldo #' " + // <--- AMBIL NILAI SALDO
            "style='width: 100%;' />")
        .Title("Jumlah Dibayarkan")
        .Width(150);

        // --- [PERUBAHAN 3: Auto Select D/K] ---
        columns.Template(
            "<select class='k-dropdown dk-input' disabled='disabled' style='width: 100%;'>" +
                "<option value='D' #= DefaultDK == 'D' ? 'selected' : '' #>Debet</option>" +
                "<option value='K' #= DefaultDK == 'K' ? 'selected' : '' #>Kredit</option>" +
            "</select>"
        )
        .Title("D/K").Width(100);
        
        // --- [PERUBAHAN 4: Kode Akun Readonly & Auto Fill] ---
        columns.Template(
            "<input class='k-textbox coa-input' " +
            "value='#= DefaultKodeAkun #' " + // Cukup begini, karena dari SP sudah pasti tidak NULL
            "readonly='readonly' " +
            // PENTING: Ganti #e9ecef menjadi rgb(233, 236, 239)
            "style='width: 100%; background-color: rgb(233, 236, 239);' />") 
        .Title("Kode Akun")
        .Width(250);

        columns.Bound(c => c.curensi).Title("Curensi").Width(100);
        
        columns.Template("<input type='number' class='k-textbox total-rp-input' readonly value='0' style='width: 100%;' />")
        .Title("Total Rupiah")   
        .Width(150);
        
        columns.Bound(c => c.kd_mtu).Title("Kode Mata Uang").Width(100);
        columns.Bound(c => c.nm_cust).Title("Nama Tertanggung").Width(250);
        columns.Bound(c => c.nm_cust2).Title("Reasuradur").Width(250);
        columns.Bound(c => c.date).Hidden();
    })
    .Pageable(pager => pager
        .Refresh(true)
        .Info(true)
          .PageSizes(new int[] { 10, 20, 50, 100, 500, 1000, 1200, 5000, 50000 })
    )
    .PersistSelection()
    .Sortable()
    .Filterable()
    .Scrollable()
    .Height(450)
    .Resizable(a => a.Columns(true))
    .Events(ev => ev.DataBound("onPilihNotaGridDataBound"))
)

 <div style="display: flex;padding: 20px;justify-content: flex-end;">
    <button type="button" id="btn-cancel-edit" class="btn btn-secondary" style="display: none;" onclick="clearPaymentForm()">Cancel</button>

    <button type="button" onclick="SimpanNota()" class="btn btn-primary">Simpan Nota</button>
 </div>
